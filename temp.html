<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ESP32 IoT sensor Dashboard</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    :root {
      --glass-bg: rgba(255, 255, 255, 0.06);
      --glass-border: rgba(255, 255, 255, 0.2);
      --primary: #00d4ff;
      --accent: #10b981;
      --text: #f1f1f1;
    }

    body {
      margin: 0;
      font-family: "Segoe UI", sans-serif;
      background: linear-gradient(135deg, #1e1e2f, #121212);
      color: var(--text);
      display: flex;
      flex-direction: column;
      align-items: center;
      min-height: 100vh;
      padding: 2rem;
    }

    .dashboard {
      display: grid;
      gap: 2rem;
      width: 100%;
      max-width: 1200px;
    }

    .card {
      background: var(--glass-bg);
      backdrop-filter: blur(30px) saturate(180%);
      -webkit-backdrop-filter: blur(30px) saturate(180%);
      border: 1px solid var(--glass-border);
      border-radius: 20px;
      padding: 1.5rem;
      box-shadow: 0 8px 32px rgba(0,0,0,0.4);
      transition: transform 0.3s ease;
    }

    .card:hover {
      transform: translateY(-5px);
    }

    h1 {
      text-align: center;
      font-size: 2.5rem;
      color: var(--primary);
      text-shadow: 0 0 20px rgba(0, 212, 255, 0.5);
      margin-bottom: 2rem;
    }

    .status {
      display: flex;
      justify-content: space-around;
      font-size: 1.3rem;
      font-weight: 600;
    }

    .status-item {
      text-align: center;
      padding: 1rem;
      border-radius: 15px;
      background: rgba(255, 255, 255, 0.05);
      min-width: 150px;
    }

    .temp-value {
      color: #ff6b6b;
      font-size: 2rem;
      display: block;
      margin: 0.5rem 0;
    }

    .humidity-value {
      color: #4ecdc4;
      font-size: 2rem;
      display: block;
      margin: 0.5rem 0;
    }

    .connection-status {
      text-align: center;
      margin-bottom: 1rem;
      padding: 0.5rem;
      border-radius: 10px;
      font-weight: 600;
    }

    .connected {
      background: rgba(16, 185, 129, 0.2);
      color: var(--accent);
    }

    .disconnected {
      background: rgba(239, 68, 68, 0.2);
      color: #ef4444;
    }

    .loading {
      background: rgba(251, 191, 36, 0.2);
      color: #fbbf24;
    }

    canvas {
      width: 100% !important;
      height: 400px !important;
    }

    .chart-container {
      position: relative;
    }

    .last-updated {
      text-align: center;
      color: #888;
      font-size: 0.9rem;
      margin-top: 1rem;
    }

    @media (max-width: 768px) {
      .status {
        flex-direction: column;
        gap: 1rem;
      }
      
      h1 {
        font-size: 2rem;
      }
    }
  </style>
</head>
<body>
  <h1>üå°Ô∏è ESP32 sensor Dashboard</h1>
  
  <div class="connection-status loading" id="connectionStatus">
    üîÑ Connecting to Supabase...
  </div>

  <div class="dashboard">
    <div class="card status">
      <div class="status-item">
        <div>üå°Ô∏è Temperature</div>
        <span class="temp-value" id="temp">--</span>
        <div>¬∞C</div>
      </div>
      <div class="status-item">
        <div>üíß Humidity</div>
        <span class="humidity-value" id="humidity">--</span>
        <div>%</div>
      </div>
    </div>
    
    <div class="card">
      <div class="chart-container">
        <canvas id="sensorChart"></canvas>
        <div class="last-updated" id="lastUpdated">Last updated: Never</div>
      </div>
    </div>
  </div>

  <script>
    // --- Supabase Config (CORRECTED) ---
    const supabaseUrl = 'https://itesopcbbtzqvjwnolzf.supabase.co';
    const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Iml0ZXNvcGNiYnR6cXZqd25vbHpmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTM4ODk1NjgsImV4cCI6MjA2OTQ2NTU2OH0.sroe9ltWKG4fqi_vao18lQrmkm9YvoGYjU0swRApcV4';
    const supabaseClient = supabase.createClient(supabaseUrl, supabaseKey);

    const tempEl = document.getElementById('temp');
    const humEl = document.getElementById('humidity');
    const statusEl = document.getElementById('connectionStatus');
    const lastUpdatedEl = document.getElementById('lastUpdated');
    const ctx = document.getElementById('sensorChart').getContext('2d');

    let chart = new Chart(ctx, {
      type: 'line',
      data: {
        labels: [],
        datasets: [
          {
            label: 'Temperature (¬∞C)',
            data: [],
            borderColor: '#ff6b6b',
            backgroundColor: 'rgba(255, 107, 107, 0.1)',
            borderWidth: 3,
            fill: true,
            tension: 0.4,
            pointBackgroundColor: '#ff6b6b',
            pointBorderColor: '#fff',
            pointBorderWidth: 2,
            pointRadius: 4
          },
          {
            label: 'Humidity (%)',
            data: [],
            borderColor: '#4ecdc4',
            backgroundColor: 'rgba(78, 205, 196, 0.1)',
            borderWidth: 3,
            fill: true,
            tension: 0.4,
            pointBackgroundColor: '#4ecdc4',
            pointBorderColor: '#fff',
            pointBorderWidth: 2,
            pointRadius: 4
          },
        ],
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: {
            labels: {
              color: '#f1f1f1',
              font: {
                size: 14
              }
            }
          }
        },
        scales: {
          x: {
            grid: {
              color: 'rgba(255, 255, 255, 0.1)'
            },
            ticks: { 
              color: '#aaa',
              maxTicksLimit: 10
            }
          },
          y: {
            grid: {
              color: 'rgba(255, 255, 255, 0.1)'
            },
            ticks: { 
              color: '#aaa'
            }
          }
        },
        interaction: {
          intersect: false,
          mode: 'index'
        }
      }
    });

    async function fetchsensorData() {
      try {
        console.log('Fetching sensor data from Supabase...');
        
        // Update status
        statusEl.textContent = 'üîÑ Fetching data...';
        statusEl.className = 'connection-status loading';

        const { data, error } = await supabaseClient
          .from('sensor_data')
          .select('*')
          .order('created_at', { ascending: true })  // Changed from 'Timestamp' to 'created_at'
          .limit(50); // Fetch latest 50 records

        if (error) {
          console.error('Supabase error:', error);
          throw error;
        }

        if (!data || data.length === 0) {
          console.warn('No sensor data available');
          statusEl.textContent = '‚ö†Ô∏è No data found';
          statusEl.className = 'connection-status disconnected';
          return;
        }

        console.log(`Successfully fetched ${data.length} records`);

        // Process the data
        const labels = data.map(entry => {
            const dateStr = entry.created_at;
            const date = new Date(dateStr);
            return isNaN(date.getTime()) ? 'Invalid' : date.toLocaleTimeString();
        });
        
        const temps = data.map(entry => parseFloat(entry.Temperature) || 0);
        const hums = data.map(entry => parseFloat(entry.Humidity) || 0);

        // Update chart
        chart.data.labels = labels;
        chart.data.datasets[0].data = temps;
        chart.data.datasets[1].data = hums;
        chart.update('none'); // Smooth update without animation

        // Update current values
        const latest = data[data.length - 1];
        tempEl.textContent = parseFloat(latest.Temperature).toFixed(1);
        humEl.textContent = parseFloat(latest.Humidity).toFixed(1);

        // Update status
        statusEl.textContent = '‚úÖ Connected - Data synced';
        statusEl.className = 'connection-status connected';
        lastUpdatedEl.textContent = `Last updated: ${new Date().toLocaleTimeString()}`;

      } catch (err) {
        console.error("Error fetching Supabase data:", err);
        statusEl.textContent = '‚ùå Connection failed';
        statusEl.className = 'connection-status disconnected';
        
        // Show error details in console for debugging
        if (err.message) {
          console.error('Error details:', err.message);
        }
      }
    }

    // Test connection and fetch initial data
    async function initDashboard() {
      console.log('Initializing ESP32 Dashboard...');
      await fetchsensorData();
    }

    // Initialize dashboard
    initDashboard();

    // Auto-refresh every 10 seconds
    setInterval(fetchsensorData, 10000);

    // Handle page visibility changes (pause updates when tab is hidden)
    document.addEventListener('visibilitychange', function() {
      if (document.visibilityState === 'visible') {
        fetchsensorData();
      }
    });
  </script>
</body>
</html>